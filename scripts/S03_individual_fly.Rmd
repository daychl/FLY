---
title: "individual_fly_analysis"
author: "daisy"
date: "2025-08-18"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

source("/Users/day/Documents/Year 2/Summer Project/Project/FLY/scripts/S00_data_source.R")

## Data importing

```{r block1, echo=FALSE}
#Importing data 
library(readxl)
individual_fly_data <- read_excel("/Users/day/Documents/Year 2/Summer Project/Project/FLY/data/individual_fly_data.xlsx")
```

## Data plotting
To make the order of the four genotypes and the three treatment consistent.
```{r block2, echo=FALSE}
#Changing order of genotype
unique(individual_fly_data$genotype)
individual_fly_data$genotype <- factor(
  individual_fly_data$genotype,
  levels = c("tT", "mT", "tM", "mM")
  )

#Changing order of treatment
unique(individual_fly_data$treatment)
individual_fly_data$treatment <- factor(
  individual_fly_data$treatment,
  levels = c("constant", "fluctuation_small", "fluctuation_big")
  )

```

Plotting a boxplot:
```{r block3, echo=FALSE}
library(ggplot2)

ggplot(individual_fly_data, aes(x=treatment, y=dev_time, fill=genotype)) +
  geom_boxplot(position = position_dodge(width = 0.8)) +
  scale_fill_manual(values = colour_palette) + 
  xlab("Genotype at Different Treatments") +
  ylab("Developmental Time (Hours)") +
  ggtitle("Developmental Time by Genotype and Treatments")

```
Those for the fluctuation big are across much bigger range is due to the fact that many of the flies from high fluctuation tends to emerge on a Friday, followed by a Monday count after the weekend.

Trying to put some sd bars on the plot:
```{r block8, echo=FALSE}
library(ggplot2)

ggplot(individual_fly_data, aes(x = treatment, y = dev_time, fill = genotype)) +
  geom_boxplot(position = position_dodge(width = 0.8)) +
  stat_summary(
    fun = mean,
    fun.min = function(x) mean(x) - sd(x),
    fun.max = function(x) mean(x) + sd(x),
    geom = "errorbar",
    width = 0.2,
    position = position_dodge(width = 0.8),
    color = "black"
  ) +
  stat_summary(
    fun = mean,
    geom = "point",
    position = position_dodge(width = 0.8),
    color = "black",
    size = 2
  ) +
  scale_fill_manual(values = colour_palette) +
  xlab("Genotype at Different Treatments") +
  ylab("Developmental Time (Hours)") +
  ggtitle("Developmental Time by Genotype and Treatments")

```

*Per condition:
The SD bars overlap quite a lot - which mean in terms of the spread of data, there might not be a huge difference across genotypes

However, the means are different (and are significantly different evidenced by teh TukeyHSD below)


#Statistical analysis
Perform a two-way ANOVA to test the main effects of genotype and treatment and their interaction.
```{r block4, echo=FALSE}
anova_result <- aov(dev_time ~ genotype * treatment, data = individual_fly_data)
summary(anova_result)

TukeyHSD(anova_result)

tukey_results <- TukeyHSD(anova_result)
```

Trying to save the ouput into an excel file
```{r block5, echo=FALSE}
geno_results <- data.frame(Comparison = rownames(tukey_results$genotype),
                           as.data.frame(tukey_results$genotype),
                           row.names = NULL)

treat_results <- data.frame(Comparison = rownames(tukey_results$treatment),
                            as.data.frame(tukey_results$treatment),
                            row.names = NULL)

inter_results <- data.frame(Comparison = rownames(tukey_results$`genotype:treatment`),
                            as.data.frame(tukey_results$`genotype:treatment`),
                            row.names = NULL)
tukey_list <- list(
  Genotype = geno_results,
  Treatment = treat_results,
  Interaction = inter_results
)

write_xlsx(tukey_list, "TukeyHSD_results.xlsx")


```

# Running ANOVA per condition 
This shows whether per treatment, genotypes is the effect of altering development time

```{r block6, echo=FALSE}

unique_treatments <- unique(individual_fly_data$treatment)

anova_results2 <- lapply(unique_treatments, function(trt) {
  subset_data <- individual_fly_data %>% filter(treatment == trt)
  anova_result2 <- aov(dev_time ~ genotype, data = subset_data)
  summary(anova_result2)  # ANOVA table for this treatment
})

names(anova_results2) <- unique_treatments
anova_results2

```
# Running follow-up tukeyHSD for each condition
```{r block7, echo=FALSE}

unique_treatments <- unique(individual_fly_data$treatment)

tukey_results2 <- lapply(unique_treatments, function(trt) {
  subset_data <- individual_fly_data %>% filter(treatment == trt)
  aov_result <- aov(dev_time ~ genotype, data = subset_data)
  tukey <- TukeyHSD(aov_result)
  
  df <- data.frame(Comparison = rownames(tukey$genotype),
                   as.data.frame(tukey$genotype),
                   row.names = NULL)
  return(df)
})

write_xlsx(tukey_results2, "TukeyHSD_per_condition.xlsx")

```

Significant results (pair-wise):
1. constant:
tM-tT
mM-tT
tM-mT

2. fluctuation_small:
tM-tT
mM-tT
